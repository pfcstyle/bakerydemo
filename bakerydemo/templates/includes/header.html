{% load navigation_tags %}
{% load static %}

<header class="header clearfix">
    <script src="{% static 'js/jquery-1.9.1.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <div class="container">
        <div class="navigation" data-navigation>
            <a href="/" class="navigation__logo">The Wagtail Bakery</a>

            <button
                type="button"
                class="navigation__mobile-toggle"
                aria-label="Toggle mobile menu"
                aria-expanded="false"
                data-mobile-navigation-toggle
            >
                <span class="navigation__toggle-icon-bar"></span>
                <span class="navigation__toggle-icon-bar"></span>
                <span class="navigation__toggle-icon-bar"></span>
            </button>

            <nav class="navigation__mobile" data-mobile-navigation hidden>
                <a href="/" class="navigation__logo">The Wagtail Bakery</a>
                <ul class="navigation__items nav-pills">
                    {# main_menu is defined in base/templatetags/navigation_tags.py #}
                    {% get_site_root as site_root %}
                    {% top_menu parent=site_root calling_page=self %}
                </ul>
                <form action="/search" method="get" class="navigation__mobile-search" role="search">
                    <label for="mobile-search-input" class="u-sr-only">Search the bakery</label>
                    <input class="navigation__search-input" id="mobile-search-input" type="text" placeholder="Search" autocomplete="off" name="q">
                    <div aria-hidden="true" class="navigation__search-icon">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.5 11H11.71L11.43 10.73C12.41 9.59 13 8.11 13 6.5C13 2.91 10.09 0 6.5 0C2.91 0 0 2.91 0 6.5C0 10.09 2.91 13 6.5 13C8.11 13 9.59 12.41 10.73 11.43L11 11.71V12.5L16 17.49L17.49 16L12.5 11ZM6.5 11C4.01 11 2 8.99 2 6.5C2 4.01 4.01 2 6.5 2C8.99 2 11 4.01 11 6.5C11 8.99 8.99 11 6.5 11Z" fill="#333" />
                        </svg>
                    </div>
                </form>
            </nav>

            <nav class="navigation__desktop" aria-label="Main">
                <ul class="navigation__items nav-pills">
                    {# main_menu is defined in base/templatetags/navigation_tags.py #}
                    {% get_site_root as site_root %}
                    {% top_menu parent=site_root calling_page=self %}
                </ul>
            </nav>

            <div class="flex-container">
                <form action="/search" method="get" class="navigation__search" role="search">
                    <label for="search-input" class="u-sr-only">Search the bakery</label>
                    <input class="navigation__search-input" id="search-input" type="text" placeholder="Search" autocomplete="off" name="q">
                    <div aria-hidden="true" class="navigation__search-icon">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.5 11H11.71L11.43 10.73C12.41 9.59 13 8.11 13 6.5C13 2.91 10.09 0 6.5 0C2.91 0 0 2.91 0 6.5C0 10.09 2.91 13 6.5 13C8.11 13 9.59 12.41 10.73 11.43L11 11.71V12.5L16 17.49L17.49 16L12.5 11ZM6.5 11C4.01 11 2 8.99 2 6.5C2 4.01 4.01 2 6.5 2C8.99 2 11 4.01 11 6.5C11 8.99 8.99 11 6.5 11Z" fill="#333" />
                        </svg>
                    </div>
                </form>
    
                <div class="navigation__user-info ml-2 dropdown">
                    <!-- 添加登录按钮 -->
                    <button id="login-button" class="btn btn-success" data-toggle="modal" data-target="#login-modal">登录</button>
                    <div id="user-info" class="user-info d-none align-items-center dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="cursor: pointer;">
                        <img id="user-portrait" class="img-circle" src="{% static 'img/thumbnail.png' %}" width="40" height="40">
                        <span id="user-nickname"></span>
                    </div>
                    <ul class="dropdown-menu dropdown-menu-right" id="user-dropdown-menu" style="background-color: white;padding: 0;">
                        <!-- <li><a href="#" id="user-details">用户信息</a></li> -->
                        <li><a href="#" id="logout">登出</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
        
    </div>
</header>

<!-- 登录对话框 -->
<div id="login-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title text-center">
                    <img src="{% static 'img/thumbnail.png' %}" alt="Logo" class="center-block" style="height: 50px;width: 50px;">
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label for="phone" class="control-label">手机号:</label>
                        <input type="text" class="form-control" id="phone" name="phone" placeholder="请输入手机号" required>
                        <div id="phone-error" class="text-danger" style="display:none;">手机号码格式不正确，请重新输入</div>
                    </div>
                    <div class="form-group">
                        <label for="code" class="control-label">验证码:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="code" name="code" placeholder="请输入验证码" required>
                            <span class="input-group-btn">
                                <button type="button" id="send-code-button" class="btn btn-default align-items-center">                    
                                    <span class="loading-spinner invisible"></span>
                                    获取验证码
                                </button>
                            </span>
                        </div>
                        <div id="code-sent-message" class="help-block text-success" style="display:none;font-size: 10px;">短信验证码已发送，可能会有延迟，请耐心等待</div>
                        <div id="code-error" class="text-danger" style="display:none;">验证码错误</div>
                    </div>
                    <div class="form-group text-center">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="terms-checkbox" required> 我已阅读并同意 <a href="#">用户协议</a> 和 <a href="#">隐私政策</a>
                            </label>
                        </div>
                        <div id="terms-error" class="text-danger" style="display:none;">请阅读并同意用户协议和隐私政策</div>
                    </div>
                    <div class="form-group text-center">
                        <button type="submit" class="btn btn-primary btn-block">
                            <span class="loading-spinner invisible"></span>
                            登录
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



<style>
    .flex-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-grow: 1;
    }

    .align-items-center {
        align-items: center;
    }

    .ml-2 {
        margin-left: 1rem;
    }

    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }

    .modal-content {
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, .5);
    }

    .modal-header {
        border-bottom: none;
        position: relative;
    }

    .modal-header .close {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 24px;
    }

    .modal-body {
        padding: 20px 40px;
    }

    .input-group .form-control {
        border-right: 0;
    }

    .input-group-btn .btn {
        border-left: 0;
        background-color: #f5f5f5;
        color: #333;
    }

    .input-group-btn .btn:disabled {
        background-color: #ddd;
        color: #999;
    }

    #login-modal .form-group {
        margin-bottom: 20px;
    }

    #login-modal .btn-primary {
        background-color: #5cb85c;
        border-color: #5cb85c;
        font-size: 16px;
        padding: 10px 20px;
        border-radius: 5px;
    }

    #login-modal .btn-primary:hover {
        background-color: #4cae4c;
        border-color: #4cae4c;
    }

    #login-modal .checkbox label {
        font-size: 14px;
        color: #666;
    }

    #login-modal .checkbox a {
        color: #337ab7;
    }

    #login-modal .checkbox a:hover {
        color: #23527c;
        text-decoration: underline;
    }

    #login-modal .help-block {
        margin-top: 10px;
    }

    .text-danger {
        font-size: 12px;
        margin-top: 5px;
    }


    .user-info {
        display: flex;
        align-items: center;
    }

    .img-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .d-none {
        display: none;
    }

    #send-code-button {
        min-width: 120px; /* 根据按钮的最大文本长度设置适当的宽度 */
    }

    .loading-spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(0, 0, 0, .1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 5px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 登录按钮
        const loginButton = document.getElementById('login-button');
        // 登录弹框
        const closeModalButton = document.querySelector('#login-modal .close');
        const sendCodeButton = document.getElementById('send-code-button');
        const sendCodeSpinner = sendCodeButton.querySelector('.loading-spinner');
        const codeSentMessage = document.getElementById('code-sent-message');
        const phoneError = document.getElementById('phone-error');
        const codeError = document.getElementById('code-error');
        const termsCheckbox = document.getElementById('terms-checkbox');
        const termsError = document.getElementById('terms-error');
        const loginFormButton = document.getElementById('login-modal').querySelector('button[type="submit"]');
        const loginFormSpinner = loginFormButton.querySelector('.loading-spinner');
        
        // 用户信息
        const userInfo = document.getElementById('user-info');
        const userPortrait = document.getElementById('user-portrait');
        const userNickname = document.getElementById('user-nickname');

        // 尝试从Cookie读取用户信息
        const savedUser = getCookie('user_info');
        if (savedUser) {
            const user = JSON.parse(savedUser);
            showUserInfo(user);
        }else{
            loginButton.style.display = 'block';
            // 隐藏用户信息
            userInfo.classList.add('d-none');
        }

        sendCodeButton.addEventListener('click', function() {
            const phoneNumber = document.getElementById('phone').value;
            if (!validatePhoneNumber(phoneNumber)) {
                phoneError.style.display = 'block';
                return;
            }
            phoneError.style.display = 'none';
            sendCodeButton.disabled = true;
            sendCodeSpinner.classList.remove('invisible');
            codeSentMessage.style.display = 'none';
            fetch(`https://piek.top/api/v1/users/send_auth_code?phone_number=${phoneNumber}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('发送验证码失败');
                    }
                    return response.json();
                })
                .then(data => {
                    sendCodeButton.disabled = false;
                    sendCodeSpinner.classList.add('invisible');
                    if (data.code === 1000 && data.msg === "success") {
                        codeSentMessage.style.display = 'block';
                        startCountdown(sendCodeButton, 60);
                    } else {
                        alert('发送验证码失败');
                    }
                })
                .catch(() => {
                    sendCodeButton.disabled = false;
                    alert('发送验证码失败');
                });
        });

        function validatePhoneNumber(phone) {
            const phoneRegex = /^1[3-9]\d{9}$/;
            return phoneRegex.test(phone);
        }

        function startCountdown(button, seconds) {
            let remaining = seconds;
            button.textContent = `${remaining}秒后重发`;

            const countdownInterval = setInterval(() => {
                remaining -= 1;
                button.textContent = `${remaining}秒后重发`;

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    button.disabled = false;
                    button.textContent = '获取验证码';
                }
            }, 1000);
        }

        $('#login-form').on('submit', function(event) {
            event.preventDefault();
            loginFormButton.disabled = true;
            const phoneNumber = $('#phone').val();
            const authCode = $('#code').val();
            const clientId = 'Gl6fnZ3eyp0DVYNsSbSMXl2OPmZJp027FgsQ5rvY';  // 替换为你的client_id
            const termsAccepted = termsCheckbox.checked;
            
            if (!termsAccepted) {
                termsError.style.display = 'block';
                return;
            }
            termsError.style.display = 'none';

            if (!validatePhoneNumber(phoneNumber)) {
                phoneError.style.display = 'block';
                return;
            }
            phoneError.style.display = 'none';
            loginFormSpinner.classList.remove('invisible');
            fetch('https://piek.top/api/v1/users/login/auth_code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    phone_number: phoneNumber,
                    auth_code: authCode,
                    client_id: clientId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('登录失败');
                }
                return response.json();
            }).then(data => {
                loginFormButton.disabled = false;
                loginFormSpinner.classList.add('invisible');
                console.log(data)
                if (data.code === 1000 && data.msg === "success") {
                    closeModalButton.click();
                    const user = data.data.user;
                    showUserInfo(user);
                    setCookie('user_info', JSON.stringify(user), 7);  // 保存用户信息到Cookie，7天有效
                } else {
                    codeError.style.display = 'block';
                }
            }).catch((e) => {
                console.error(e);
                loginFormButton.disabled = false;
                loginFormSpinner.classList.add('invisible');
                codeError.style.display = 'block';
            });
        });

        $('#logout').on('click', function() {
            setCookie('user_info', '', -1);  // 清除用户信息的Cookie
            loginButton.style.display = 'block';
            userInfo.classList.add('d-none');
        });

        // $('#user-details').on('click', function() {
        //     alert('用户信息: ' + JSON.stringify({
        //         nickname: userNickname.textContent,
        //         portrait: userPortrait.src
        //     }));
        // });

        // 点击空白处隐藏下拉菜单
        // $(document).on('click', function(event) {
        //     if (!$(event.target).closest('.navigation__user-info').length) {
        //         $('.dropdown-toggle').dropdown('hide');
        //     }
        // });

        function showUserInfo(user) {
            loginButton.style.display = 'none';
            userInfo.classList.remove('d-none');
            userPortrait.src = user.portrait || "{% static 'img/thumbnail.png' %}";
            userNickname.textContent = user.nickname;
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
        }

        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? decodeURIComponent(parts[1]) : r
            }, '');
        }
    });
</script>