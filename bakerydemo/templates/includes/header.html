{% load navigation_tags %}
{% load static %}

<header class="header clearfix">
    <div class="container">
        <div class="navigation" data-navigation>
            <a href="/" class="navigation__logo">The Wagtail Bakery</a>

            <button
                type="button"
                class="navigation__mobile-toggle"
                aria-label="Toggle mobile menu"
                aria-expanded="false"
                data-mobile-navigation-toggle
            >
                <span class="navigation__toggle-icon-bar"></span>
                <span class="navigation__toggle-icon-bar"></span>
                <span class="navigation__toggle-icon-bar"></span>
            </button>

            <nav class="navigation__mobile" data-mobile-navigation hidden>
                <a href="/" class="navigation__logo">The Wagtail Bakery</a>
                <ul class="navigation__items nav-pills">
                    {# main_menu is defined in base/templatetags/navigation_tags.py #}
                    {% get_site_root as site_root %}
                    {% top_menu parent=site_root calling_page=self %}
                </ul>
                <form action="/search" method="get" class="navigation__mobile-search" role="search">
                    <label for="mobile-search-input" class="u-sr-only">Search the bakery</label>
                    <input class="navigation__search-input" id="mobile-search-input" type="text" placeholder="Search" autocomplete="off" name="q">
                    <div aria-hidden="true" class="navigation__search-icon">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.5 11H11.71L11.43 10.73C12.41 9.59 13 8.11 13 6.5C13 2.91 10.09 0 6.5 0C2.91 0 0 2.91 0 6.5C0 10.09 2.91 13 6.5 13C8.11 13 9.59 12.41 10.73 11.43L11 11.71V12.5L16 17.49L17.49 16L12.5 11ZM6.5 11C4.01 11 2 8.99 2 6.5C2 4.01 4.01 2 6.5 2C8.99 2 11 4.01 11 6.5C11 8.99 8.99 11 6.5 11Z" fill="#333" />
                        </svg>
                    </div>
                </form>
            </nav>

            <nav class="navigation__desktop" aria-label="Main">
                <ul class="navigation__items nav-pills">
                    {# main_menu is defined in base/templatetags/navigation_tags.py #}
                    {% get_site_root as site_root %}
                    {% top_menu parent=site_root calling_page=self %}
                </ul>
            </nav>

            <div class="flex-container">
                <form action="/search" method="get" class="navigation__search" role="search">
                    <label for="search-input" class="u-sr-only">Search the bakery</label>
                    <input class="navigation__search-input" id="search-input" type="text" placeholder="Search" autocomplete="off" name="q">
                    <div aria-hidden="true" class="navigation__search-icon">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.5 11H11.71L11.43 10.73C12.41 9.59 13 8.11 13 6.5C13 2.91 10.09 0 6.5 0C2.91 0 0 2.91 0 6.5C0 10.09 2.91 13 6.5 13C8.11 13 9.59 12.41 10.73 11.43L11 11.71V12.5L16 17.49L17.49 16L12.5 11ZM6.5 11C4.01 11 2 8.99 2 6.5C2 4.01 4.01 2 6.5 2C8.99 2 11 4.01 11 6.5C11 8.99 8.99 11 6.5 11Z" fill="#333" />
                        </svg>
                    </div>
                </form>
    
                <div class="navigation__user-info ml-2">
                    <!-- 添加登录按钮 -->
                   <button id="login-button" class="btn btn-success">登录</button>
                   <div id="user-info" class="d-none align-items-center">
                       <img id="user-portrait" class="img-circle" src="{% static 'img/thumbnail.png' %}" width="40" height="40">
                       <span id="user-nickname"></span>
                   </div>
                </div>
            </div>
            
        </div>
        
    </div>
</header>
<!-- 登录对话框 -->
<div id="login-modal" class="modal-content, modal">
    <div class="modal-header">
        <h5 class="modal-title">登录</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <form id="login-form">
            <div class="form-group">
                <label for="phone">手机号:</label>
                <input type="text" class="form-control" id="phone" name="phone" required>
            </div>
            <div class="form-group">
                <button type="button" id="send-code-button" class="btn btn-primary align-items-center">
                    <span class="loading-spinner hidden"></span>发送验证码
                </button>
            </div>
            <div class="form-group">
                <label for="code">验证码:</label>
                <input type="text" class="form-control" id="code" name="code" required>
            </div>
            <button type="submit" class="btn btn-success align-items-center">
                <span class="loading-spinner hidden"></span>登录
            </button>
        </form>
    </div>
</div>

<style>
    .flex-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-grow: 1;
    }

    .align-items-center {
        align-items: center;
    }

    .ml-2 {
        margin-left: 1rem;
    }

    .modal {
        display: none; /* 隐藏 */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    .modal.active {
        display: block; /* 显示 */
    }

    .disabled-button {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .user-info {
        display: flex;
        align-items: center;
    }

    .img-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .d-none {
        display: none;
    }

    .hidden {
        display: none;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(0, 0, 0, .1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 5px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loginButton = document.getElementById('login-button');
        const loginModal = document.getElementById('login-modal');
        const closeModalButtons = document.querySelectorAll('.close');
        const sendCodeButton = document.getElementById('send-code-button');
        const sendCodeSpinner = sendCodeButton.querySelector('.loading-spinner');
        const loginForm = document.getElementById('login-form');
        const loginFormButton = loginForm.querySelector('button[type="submit"]');
        const loginFormSpinner = loginFormButton.querySelector('.loading-spinner');
        const userInfo = document.getElementById('user-info');
        const userPortrait = document.getElementById('user-portrait');
        const userNickname = document.getElementById('user-nickname');

        // 尝试从Cookie读取用户信息
        const savedUser = getCookie('user_info');
        if (savedUser) {
            const user = JSON.parse(savedUser);
            showUserInfo(user);
        }else{
            loginButton.style.display = 'block';
            // 隐藏用户信息
            userInfo.classList.add('d-none');
        }

        loginButton.addEventListener('click', function(event) {
            event.preventDefault();
            loginModal.classList.add('active');
        });

        closeModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                loginModal.classList.remove('active');
            });
        });

        sendCodeButton.addEventListener('click', function() {
            sendCodeButton.disabled = true;
            const phoneNumber = document.getElementById('phone').value;
            sendCodeSpinner.classList.remove('hidden');
            fetch(`https://piek.top/api/v1/users/send_auth_code?phone_number=${phoneNumber}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('发送验证码失败');
                    }
                    return response.json();
                })
                .then(data => {
                    sendCodeButton.disabled = false;
                    sendCodeSpinner.classList.add('hidden');
                    if (data.code === 1000 && data.msg === "success") {
                        alert('验证码已发送');
                        startCountdown(sendCodeButton, 60);
                    } else {
                        alert('发送验证码失败');
                    }
                })
                .catch(() => {
                    sendCodeButton.disabled = false;
                    sendCodeSpinner.classList.add('hidden');
                    alert('发送验证码失败');
                });
        });

        function startCountdown(button, seconds) {
            button.disabled = true;
            button.classList.add('disabled-button');
            let remaining = seconds;
            button.textContent = `${remaining}s`;

            const countdownInterval = setInterval(() => {
                remaining -= 1;
                button.textContent = `${remaining}s`;

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    button.disabled = false;
                    button.classList.remove('disabled-button');
                    button.textContent = '发送验证码';
                }
            }, 1000);
        }

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            loginFormButton.disabled = true;
            loginFormSpinner.classList.remove('hidden');
            const phoneNumber = document.getElementById('phone').value;
            const authCode = document.getElementById('code').value;
            const clientId = 'Gl6fnZ3eyp0DVYNsSbSMXl2OPmZJp027FgsQ5rvY';  // 替换为你的client_id

            fetch('https://piek.top/api/v1/users/login/auth_code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    phone_number: phoneNumber,
                    auth_code: authCode,
                    client_id: clientId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('登录失败');
                }
                return response.json();
            })
            .then(data => {
                loginFormButton.disabled = false;
                loginFormSpinner.classList.add('hidden');
                if (data.code === 1000 && data.msg === "success") {
                    const user = data.data.user;
                    showUserInfo(user);
                    setCookie('user_info', JSON.stringify(user), 7);  // 保存用户信息到Cookie，7天有效
                    loginModal.classList.remove('active');
                } else {
                    alert('登录失败: ' + data.msg);
                }
            })
            .catch(() => {
                loginFormButton.disabled = false;
                loginFormSpinner.classList.add('hidden');
                alert('登录失败');
            });
        });

        function showUserInfo(user) {
            loginButton.style.display = 'none';
            userInfo.classList.remove('d-none');  // 修改为移除 d-none 类
            userInfo.style.display = 'flex';  // 显示用户信息
            userPortrait.src = user.portrait || "{% static 'img/thumbnail.png' %}";
            userNickname.textContent = user.nickname;
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
        }

        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? decodeURIComponent(parts[1]) : r
            }, '');
        }
    });
</script>